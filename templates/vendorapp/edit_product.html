{% extends 'vendorapp/base.html' %}

{% block title %}Edit Product{% endblock %}

{% block admin_content %}
<div class="card">
    <div class="card-body">
        <h5 class="card-title mb-4">Edit Product: {{ product.model_name }}</h5>
        <form method="post" enctype="multipart/form-data" id="edit-product-form">
            {% csrf_token %}
            <div class="row">
                <div class="mb-3 col-md-6">
                    <label for="id_model_name" class="form-label">Model Name</label>
                    <input type="text" name="model_name" id="id_model_name" class="form-control" value="{{ product.model_name }}" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_brand" class="form-label">Brand</label>
                    {{ form.brand }}
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_category" class="form-label">Category</label>
                    {{ form.category }}
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_base_price" class="form-label">Base Price</label>
                    <input type="number" name="base_price" id="id_base_price" class="form-control" value="{{ product.base_price }}" step="0.01" min="0" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_stock_quantity" class="form-label">Stock Quantity</label>
                    <input type="number" name="stock_quantity" id="id_stock_quantity" class="form-control" value="{{ product.stock_quantity }}" min="0" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_color" class="form-label">Color</label>
                    <input type="text" name="color" id="id_color" class="form-control" value="{{ product.color }}" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_strap_material" class="form-label">Strap Material</label>
                    <input type="text" name="strap_material" id="id_strap_material" class="form-control" value="{{ product.strap_material }}" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_case_size" class="form-label">Case Size (mm)</label>
                    <input type="number" name="case_size" id="id_case_size" class="form-control" value="{{ product.case_size }}" step="0.1" min="0" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_movement_type" class="form-label">Movement Type</label>
                    <input type="text" name="movement_type" id="id_movement_type" class="form-control" value="{{ product.movement_type }}" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_water_resistance" class="form-label">Water Resistance</label>
                    <input type="text" name="water_resistance" id="id_water_resistance" class="form-control" value="{{ product.water_resistance }}" required>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_display_type" class="form-label">Display Type</label>
                    <input type="text" name="display_type" id="id_display_type" class="form-control" value="{{ product.display_type }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_style_code" class="form-label">Style Code</label>
                    <input type="text" name="style_code" id="id_style_code" class="form-control" value="{{ product.style_code }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_series" class="form-label">Series</label>
                    <input type="text" name="series" id="id_series" class="form-control" value="{{ product.series }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_occasion" class="form-label">Occasion</label>
                    <input type="text" name="occasion" id="id_occasion" class="form-control" value="{{ product.occasion }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_pack_of" class="form-label">Pack of</label>
                    <input type="number" name="pack_of" id="id_pack_of" class="form-control" value="{{ product.pack_of }}" min="1">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_strap_color" class="form-label">Strap Color</label>
                    <input type="text" name="strap_color" id="id_strap_color" class="form-control" value="{{ product.strap_color }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_net_quantity" class="form-label">Net Quantity</label>
                    <input type="number" name="net_quantity" id="id_net_quantity" class="form-control" value="{{ product.net_quantity }}" min="1">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_strap_type" class="form-label">Strap Type</label>
                    <input type="text" name="strap_type" id="id_strap_type" class="form-control" value="{{ product.strap_type }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_case_material" class="form-label">Case Material</label>
                    <input type="text" name="case_material" id="id_case_material" class="form-control" value="{{ product.case_material }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_water_resistance_depth" class="form-label">Water Resistance Depth (m)</label>
                    <input type="number" name="water_resistance_depth" id="id_water_resistance_depth" class="form-control" value="{{ product.water_resistance_depth }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_dial_color" class="form-label">Dial Color</label>
                    <input type="text" name="dial_color" id="id_dial_color" class="form-control" value="{{ product.dial_color }}">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_width" class="form-label">Width (mm)</label>
                    <input type="number" name="width" id="id_width" class="form-control" value="{{ product.width }}" step="0.1">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_diameter" class="form-label">Diameter (mm)</label>
                    <input type="number" name="diameter" id="id_diameter" class="form-control" value="{{ product.diameter }}" step="0.1">
                </div>
                <div class="mb-3 col-md-6">
                    <label for="id_warranty_period" class="form-label">Warranty Period (months)</label>
                    <input type="number" name="warranty_period" id="id_warranty_period" class="form-control" value="{{ product.warranty_period }}">
                </div>
                <div class="mb-3 col-12">
                    <label for="id_description" class="form-label">Description</label>
                    <textarea name="description" id="id_description" class="form-control" rows="4" required>{{ product.description }}</textarea>
                </div>
            </div>
            <div class="mb-3">
                <label for="primary_image" class="form-label">Primary Image</label>
                {% if product.primary_image %}
                    <img src="{{ product.primary_image.url }}" alt="Primary Image" class="img-thumbnail mb-2" style="max-width: 200px;">
                {% elif product.additional_images.first %}
                    <img src="{{ product.additional_images.first.image.url }}" alt="Primary Image" class="img-thumbnail mb-2" style="max-width: 200px;">
                    <p class="text-muted">No primary image set. Showing the first additional image.</p>
                {% else %}
                    <p class="text-muted">No primary image available.</p>
                {% endif %}
                <input type="file" name="primary_image" id="primary_image" class="form-control" accept="image/*">
            </div>
            <div class="mb-3">
                <label for="product_images" class="form-label">Additional Product Images</label>
                <div id="existing-images" class="mb-2">
                    {% for image in product.additional_images.all %}
                        <div class="image-container d-inline-block position-relative mr-2">
                            <img src="{{ image.image.url }}" alt="Additional Image" class="img-thumbnail" style="max-width: 100px;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 remove-image" data-image-id="{{ image.id }}">X</button>
                        </div>
                    {% endfor %}
                </div>
                <div id="drop-area" class="drop-area">
                    <p>Drag and drop images here or click to browse</p>
                    <input type="file" name="product_images" id="product_images" class="form-control" multiple accept="image/*" style="display: none;">
                    <div id="image-preview" class="mt-3 d-flex flex-wrap"></div>
                </div>
            </div>
            <div class="d-flex mt-3 column-gap-4 text-center">
                <button type="submit" class="button w-100 rounded-3">Update Product</button>
                <a href="{% url 'vendorapp:product_list' %}" class="button button--gray w-100 rounded-3">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let dropArea = document.getElementById('drop-area');
    let fileInput = document.getElementById('product_images');
    let preview = document.getElementById('image-preview');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropArea.classList.add('highlight');
    }

    function unhighlight(e) {
        dropArea.classList.remove('highlight');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        let dt = e.dataTransfer;
        let files = dt.files;
        handleFiles(files);
    }

    dropArea.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        ([...files]).forEach(previewFile);
    }

    function previewFile(file) {
        let reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onloadend = function() {
            let div = document.createElement('div');
            div.className = 'image-container';
            div.innerHTML = `
                <img src="${reader.result}" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                <span class="close-btn">&times;</span>
            `;
            preview.appendChild(div);

            div.querySelector('.close-btn').addEventListener('click', function() {
                div.remove();
            });
        }
    }   
    document.querySelectorAll('.remove-image').forEach(button => {
        button.addEventListener('click', function() {
            const imageId = this.dataset.imageId;
            fetch(`/vendor/delete-product-image/${imageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.closest('.image-container').remove();
                }
            });
        });
    });
</script>
{% endblock %}
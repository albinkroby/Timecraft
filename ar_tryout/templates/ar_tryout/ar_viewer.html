{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Watch Try-On</title>

    <!-- Add Boxicons for UI -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Core dependencies -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
        }
    }
    </script>
    
    <!-- Load Three.js modules -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // Make THREE available globally
        window.THREE = THREE;
        window.OrbitControls = OrbitControls;
        window.GLTFLoader = GLTFLoader;
    </script>
    
    <!-- Load TensorFlow.js and Handpose -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>
    
    <!-- Load custom scripts after Three.js modules are loaded -->
    <script>
        // Function to load script and wait for it to be ready
        function loadScript(url, retries = 3) {
            return new Promise((resolve, reject) => {
                function attemptLoad(attemptsLeft) {
                const script = document.createElement('script');
                    script.src = url;
                    script.crossOrigin = 'anonymous';
                    
                    script.onload = () => {
                        console.log(`Successfully loaded: ${url}`);
                        resolve();
                    };
                    
                    script.onerror = (error) => {
                        console.error(`Error loading ${url}:`, error);
                        if (attemptsLeft > 0) {
                            console.log(`Retrying... ${attemptsLeft} attempts left`);
                            setTimeout(() => attemptLoad(attemptsLeft - 1), 1000);
                        } else {
                            reject(new Error(`Failed to load script: ${url}`));
                        }
                    };
                    
                document.head.appendChild(script);
                }
                
                attemptLoad(retries);
            });
        }

        async function loadCustomScripts() {
            try {
                // Check if camera is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('Camera API not supported in this browser');
                    
                    // Show fallback message
                    const fallbackMessage = document.getElementById('fallback-message');
                    const loadingScreen = document.getElementById('loading-screen');
                    
                    if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                    }
                    
                    if (fallbackMessage) {
                        fallbackMessage.innerHTML = `
                            <h3>Camera Not Supported</h3>
                            <p>Your browser doesn't support camera access, which is required for the AR experience.</p>
                            <p>You can still view the watch in 3D mode.</p>
                            <div class="fallback-buttons">
                                <button id="view-model-btn-nosupport" class="fallback-btn">
                                    <i class='bx bx-cube'></i> View 3D Model
                                </button>
                            </div>
                        `;
                        fallbackMessage.style.display = 'block';
                        
                        // Add event listener for the 3D model button
                        setTimeout(() => {
                            const viewModelBtn = document.getElementById('view-model-btn-nosupport');
                            if (viewModelBtn) {
                                viewModelBtn.onclick = () => {
                                    // Start directly in fallback mode (3D viewer)
                                    initializeFallbackDirectly();
                                    fallbackMessage.style.display = 'none';
                                };
                            }
                        }, 0);
                        
                        return;
                    }
                }
                
                // Load custom scripts
                await Promise.all([
                    loadScript("{% static 'ar_tryout/js/wrist_detection.js' %}"),
                    loadScript("{% static 'ar_tryout/js/model_viewer.js' %}")
                ]);
                
                // Check if we should start in fallback mode
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                
                if (mode === 'fallback') {
                    // Start directly in fallback mode (3D viewer)
                    initializeFallbackDirectly();
                } else {
                    // Initialize the AR experience
                    initializeExperience();
                }
            } catch (error) {
                console.error('Error loading scripts:', error);
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = 'Error loading required components. Please try refreshing the page.';
                }
                // Show detailed error message
                const fallbackMessage = document.getElementById('fallback-message');
                if (fallbackMessage) {
                    fallbackMessage.style.display = 'block';
                    fallbackMessage.innerHTML = `
                        <h3>Loading Error</h3>
                        <p>There was a problem loading the required components:</p>
                        <p style="color: #ff6b6b; font-family: monospace; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px;">
                            ${error.message}
                        </p>
                        <p>Please check your internet connection and try refreshing the page.</p>
                        <button onclick="window.location.reload()" class="control-btn" style="margin: 10px auto; display: block;">
                            <i class='bx bx-refresh'></i> Retry
                        </button>
                    `;
                }
            }
        }
    </script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000000;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #ar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Add styles for the video element that will be created by the script */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .controls {
            position: absolute;
            bottom: 30px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .status-message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .fallback-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .controls {
                bottom: 20px;
                right: 10px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }

        /* Additional styles for hand guide */
        .hand-guide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .guide-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
        }
        
        .guide-content h3 {
            margin-top: 0;
            color: #333;
        }
        
        .hand-illustration {
            margin: 15px auto;
            width: 150px;
            height: 150px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .guide-content ul {
            padding-left: 20px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .guide-content li {
            margin-bottom: 8px;
            color: #555;
        }
        
        .guide-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .guide-btn:hover {
            background: #5b4bc4;
        }

        /* Camera preview styles - make it smaller and more transparent */
        .camera-preview {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 150px;
            height: 112px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 12px;
        }
        
        .preview-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
        }
        
        #preview-canvas {
            width: 100%;
            height: calc(100% - 50px);
            object-fit: cover;
        }
        
        .preview-status {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 12px;
            text-align: center;
        }
        
        .preview-status.detected {
            background: rgba(76, 209, 55, 0.7);
        }
        
        .preview-status.error {
            background: rgba(255, 107, 107, 0.7);
        }

        @media (max-width: 768px) {
            .camera-preview {
                bottom: 80px;
                right: 10px;
                width: 160px;
                height: 120px;
            }
        }

        /* Fallback message styles */
        .fallback-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .fallback-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .fallback-btn:hover {
            background: #5b4bc4;
            transform: translateY(-2px);
        }
        
        #try-again-btn {
            background: #4cd137;
        }
        
        #try-again-btn:hover {
            background: #44bd32;
        }

        /* Size control styles */
        .size-control {
            position: absolute;
            left: 20px;
            bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .size-label {
            font-size: 12px;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        #size-slider {
            width: 120px;
            margin: 5px 0;
            -webkit-appearance: none;
            height: 5px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }
        
        #size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #6c5ce7;
            cursor: pointer;
        }
        
        .size-buttons {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .size-btn {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            background: #f0f0f0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .size-btn:hover {
            background: #e0e0e0;
        }
        
        @media (max-width: 768px) {
            .size-control {
                bottom: 20px;
                left: 10px;
                padding: 8px 12px;
            }
            
            #size-slider {
                width: 100px;
            }
            
            .size-btn {
                width: 25px;
                height: 25px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="ar-canvas"></canvas>
        
        <!-- Loading screen -->
        <div class="loading-screen" id="loading-screen">
            <div class="spinner"></div>
            <div id="loading-text">Initializing...</div>
        </div>

        <!-- Status message -->
        <div class="status-message" id="status-message" style="display: none;">
            Looking for your wrist...
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="control-btn" id="exit-btn" title="Exit">
                <i class='bx bx-x'></i>
            </button>
            <button class="control-btn" id="capture-btn" title="Take Photo">
                <i class='bx bx-camera'></i>
            </button>
            <button class="control-btn" id="rotate-btn" title="Rotate Model" style="display: none;">
                <i class='bx bx-rotate-right'></i>
            </button>
        </div>

        <!-- Size control slider -->
        <div class="size-control" id="size-control" style="display: none;">
            <div class="size-label">Watch Size</div>
            <input type="range" id="size-slider" min="1" max="5" step="0.5" value="2">
            <div class="size-buttons">
                <button id="size-smaller" class="size-btn" title="Smaller">
                    <i class='bx bx-minus'></i>
                </button>
                <button id="size-larger" class="size-btn" title="Larger">
                    <i class='bx bx-plus'></i>
                </button>
            </div>
        </div>

        <!-- Fallback message -->
        <div class="fallback-message" id="fallback-message" style="display: none;">
            <h3>Wrist Tracking Issue</h3>
            <p>We're having trouble tracking your wrist accurately.</p>
            <div class="fallback-buttons">
                <button id="try-again-btn" class="fallback-btn">
                    <i class='bx bx-refresh'></i> Try Again
                </button>
                <button id="view-model-btn" class="fallback-btn">
                    <i class='bx bx-cube'></i> View 3D Model
                </button>
            </div>
        </div>

        <!-- Hand position guide -->
        <div class="hand-guide" id="hand-guide" style="display: none;">
            <div class="guide-content">
                <h3>For best results:</h3>
                <div class="hand-illustration">
                    <svg width="150" height="150" viewBox="0 0 150 150">
                        <!-- Hand outline -->
                        <path d="M75,30 C85,30 95,35 100,45 C105,55 110,70 110,85 C110,100 105,110 95,120 C85,130 65,130 55,120 C45,110 40,100 40,85 C40,70 45,55 50,45 C55,35 65,30 75,30 Z" 
                              fill="none" stroke="#6c5ce7" stroke-width="2" />
                        <!-- Wrist -->
                        <rect x="65" y="115" width="20" height="10" rx="5" fill="#ff6b6b" />
                        <!-- Fingers -->
                        <line x1="75" y1="45" x2="75" y2="25" stroke="#6c5ce7" stroke-width="2" />
                        <line x1="85" y1="50" x2="95" y2="35" stroke="#6c5ce7" stroke-width="2" />
                        <line x1="95" y1="60" x2="110" y2="55" stroke="#6c5ce7" stroke-width="2" />
                        <line x1="65" y1="50" x2="55" y2="35" stroke="#6c5ce7" stroke-width="2" />
                        <line x1="55" y1="60" x2="40" y2="55" stroke="#6c5ce7" stroke-width="2" />
                        <!-- Watch position -->
                        <circle cx="75" cy="100" r="15" fill="none" stroke="#4cd137" stroke-width="2" stroke-dasharray="5,3" />
                        <text x="75" y="100" text-anchor="middle" dominant-baseline="middle" fill="#4cd137" font-size="8">WATCH</text>
                    </svg>
                </div>
                <ul>
                    <li>Hold your hand palm up, fingers slightly spread</li>
                    <li>Ensure good lighting on your hand</li>
                    <li>Keep your hand steady and in frame</li>
                    <li>Try to keep your wrist visible (highlighted in red)</li>
                </ul>
                <button id="close-guide" class="guide-btn">Got it</button>
            </div>
        </div>

        <!-- Camera preview overlay -->
        <div class="camera-preview" id="camera-preview" style="display: none;">
            <div class="preview-header">
                <span>Camera Preview</span>
                <button id="close-preview" class="preview-close-btn">×</button>
            </div>
            <canvas id="preview-canvas"></canvas>
            <div class="preview-status" id="preview-status">Looking for hand...</div>
        </div>
    </div>

    <script>
        // Main initialization function
        async function initializeExperience() {
            // Get DOM elements
            const container = document.querySelector('.container');
            const canvas = document.getElementById('ar-canvas');
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            const statusMessage = document.getElementById('status-message');
            const fallbackMessage = document.getElementById('fallback-message');
            const exitBtn = document.getElementById('exit-btn');
            const captureBtn = document.getElementById('capture-btn');
            const rotateBtn = document.getElementById('rotate-btn');
            const handGuide = document.getElementById('hand-guide');
            const closeGuideBtn = document.getElementById('close-guide');
            const cameraPreview = document.getElementById('camera-preview');
            const previewCanvas = document.getElementById('preview-canvas');
            const previewStatus = document.getElementById('preview-status');
            const closePreviewBtn = document.getElementById('close-preview');
            const tryAgainBtn = document.getElementById('try-again-btn');
            const viewModelBtn = document.getElementById('view-model-btn');
            const sizeControl = document.getElementById('size-control');
            const sizeSlider = document.getElementById('size-slider');
            const sizeSmaller = document.getElementById('size-smaller');
            const sizeLarger = document.getElementById('size-larger');

            // Watch data from Django
            const watchData = {
                modelUrl: '{{ model_url|escapejs }}',
                slug: '{{ watch.slug|escapejs }}',
                name: '{{ watch.model_name|escapejs }}'
            };
            
            // Track detection status
            let detectionStartTime = null;
            let handDetectedOnce = false;
            let wristDetectedOnce = false;
            let previewCtx = null;
            let videoElement = null;
            let wristTracker = null;
            
            // Show hand position guide
            function showHandGuide() {
                handGuide.style.display = 'flex';
                
                // Close guide when button is clicked
                closeGuideBtn.addEventListener('click', () => {
                    handGuide.style.display = 'none';
                    
                    // Show camera preview after guide is closed
                    showCameraPreview();
                });
            }
            
            // Show camera preview
            function showCameraPreview() {
                if (!videoElement) return;
                
                cameraPreview.style.display = 'block';
                
                // Setup preview canvas
                if (previewCanvas) {
                    previewCanvas.width = 150;
                    previewCanvas.height = 75;
                    previewCtx = previewCanvas.getContext('2d');
                    
                    // Start preview update loop
                    updatePreview();
                }
                
                // Close preview when button is clicked
                closePreviewBtn.addEventListener('click', () => {
                    cameraPreview.style.display = 'none';
                });
            }
            
            // Update camera preview
            function updatePreview() {
                if (!previewCtx || !videoElement || cameraPreview.style.display === 'none') return;
                
                // Draw video frame to preview canvas
                previewCtx.drawImage(
                    videoElement, 
                    0, 0, videoElement.videoWidth, videoElement.videoHeight, 
                    0, 0, previewCanvas.width, previewCanvas.height
                );
                
                // Request next frame
                requestAnimationFrame(updatePreview);
            }
            
            // Update preview status
            function updatePreviewStatus(status, type = 'normal') {
                if (!previewStatus) return;
                
                previewStatus.textContent = status;
                
                // Remove all classes
                previewStatus.classList.remove('detected', 'error');
                
                // Add class based on type
                if (type === 'detected') {
                    previewStatus.classList.add('detected');
                } else if (type === 'error') {
                    previewStatus.classList.add('error');
                }
            }
            
            // Update status message with more detailed information
            function updateStatusMessage(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                
                if (isError) {
                    statusMessage.style.background = 'rgba(255, 0, 0, 0.7)';
                } else {
                    statusMessage.style.background = 'rgba(0, 0, 0, 0.7)';
                }
            }

            // Initialize experience
            async function initialize() {
                try {
                    loadingText.textContent = 'Checking device capabilities...';

                    // Check if required libraries are available
                    if (!window.tf || !window.handpose) {
                        console.warn('TensorFlow.js or Handpose not available');
                        throw new Error('Required libraries not available');
                    }

                    // Check if THREE.js is available
                    if (!window.THREE) {
                        console.warn('THREE.js not available');
                        throw new Error('THREE.js not available');
                    }

                    // Check for camera permission first
                    try {
                        loadingText.textContent = 'Requesting camera access...';
                        
                        // Request camera permission explicitly before initializing
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'environment' } 
                        });
                        
                        // Stop the stream immediately - we just needed to check permission
                        stream.getTracks().forEach(track => track.stop());
                        
                        console.log('Camera permission granted');
                    } catch (permissionError) {
                        console.error('Camera permission error:', permissionError);
                        
                        // Show specific error for permission denied
                        if (permissionError.name === 'NotAllowedError' || 
                            permissionError.name === 'PermissionDeniedError') {
                            throw new Error('Camera permission denied. Please allow camera access and try again.');
                        } else {
                            throw permissionError;
                        }
                    }

                    // Initialize wrist tracking
                    loadingText.textContent = 'Initializing wrist tracking...';
                    
                    // Set a timeout for wrist tracking initialization
                    try {
                        // Create a timeout promise
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('Wrist tracking initialization timed out')), 20000); // Increased timeout
                        });
                        
                        // Create the wrist tracking promise
                        const wristTrackingPromise = window.initWristTracking({
                            container: container,
                            modelUrl: watchData.modelUrl,
                            onWristDetected: handleWristDetected,
                            onWristLost: handleWristLost,
                            onVideoReady: handleVideoReady,
                            onHandDetected: handleHandDetected,
                            debug: false // Explicitly disable debug mode
                        });
                        
                        // Race the promises
                        wristTracker = await Promise.race([wristTrackingPromise, timeoutPromise]);
                        
                        if (!wristTracker) {
                            throw new Error('Failed to initialize wrist tracking');
                        }
                        
                        // Hide loading screen
                        loadingScreen.style.display = 'none';
                        statusMessage.style.display = 'block';
                        
                        // Show hand guide after a short delay
                        setTimeout(() => {
                            showHandGuide();
                        }, 1000);
                        
                        // Start detection timer
                        detectionStartTime = Date.now();
                        
                        // Set a timeout to check if we've detected anything after 15 seconds
                        setTimeout(() => {
                            if (!handDetectedOnce) {
                                updateStatusMessage('Try moving your hand in frame...', true);
                                updatePreviewStatus('No hand detected', 'error');
                            } else if (!wristDetectedOnce) {
                                updateStatusMessage('Hand detected! Try adjusting your wrist position...', false);
                                updatePreviewStatus('Hand detected, adjust wrist', 'normal');
                            }
                        }, 15000);
                        
                    } catch (trackingError) {
                        console.error('Error in wrist tracking:', trackingError);
                        
                        // Check for camera access errors
                        if (trackingError.message && (
                            trackingError.message.includes('camera') || 
                            trackingError.message.includes('video') ||
                            trackingError.message.includes('permission') ||
                            trackingError.message.includes('NotAllowedError') ||
                            trackingError.message.includes('NotReadableError')
                        )) {
                            throw new Error('Camera access error: ' + trackingError.message);
                        }
                        
                        // Check for WebGL context errors
                        if (trackingError.message && (
                            trackingError.message.includes('WebGL context') || 
                            trackingError.message.includes('WebGLRenderer')
                        )) {
                            throw new Error('WebGL context error. Please refresh the page and try again.');
                        }
                        
                        // Check for specific setupDebugCanvas error
                        if (trackingError.message && trackingError.message.includes('setupDebugCanvas is not a function')) {
                            console.warn('Debug canvas error detected, falling back to 3D viewer');
                            // Fall back to 3D viewer directly
                            initializeFallbackDirectly();
                            return;
                        }
                        
                        throw trackingError; // Re-throw to be caught by outer catch
                    }

                } catch (error) {
                    console.error('Error initializing AR:', error);
                    
                    // Hide loading screen
                    loadingScreen.style.display = 'none';
                    
                    // Customize fallback message based on error type
                    let errorTitle = 'Initialization Error';
                    let errorMessage = 'There was a problem starting the AR experience.';
                    let errorDetails = error.message || 'Unknown error';
                    
                    if (error.message && (
                        error.message.includes('camera') || 
                        error.message.includes('video') ||
                        error.message.includes('permission') ||
                        error.message.includes('NotAllowedError') ||
                        error.message.includes('NotReadableError')
                    )) {
                        errorTitle = 'Camera Access Error';
                        errorMessage = 'We couldn\'t access your camera. This feature requires camera access to work.';
                        errorDetails = 'Please check that:<br>' +
                            '• You\'ve granted camera permission to this site<br>' +
                            '• No other app is currently using your camera<br>' +
                            '• Your device has a working camera';
                    } else if (error.message && (
                        error.message.includes('WebGL context') || 
                        error.message.includes('WebGLRenderer')
                    )) {
                        errorTitle = 'Graphics Error';
                        errorMessage = 'There was a problem with your device\'s graphics system.';
                        errorDetails = 'Your browser may not support WebGL, or there might be a graphics driver issue.';
                    } else if (error.message && (
                        error.message.includes('handpose') ||
                        error.message.includes('TensorFlow')
                    )) {
                        errorTitle = 'AI Model Error';
                        errorMessage = 'There was a problem loading the hand tracking AI model.';
                        errorDetails = 'This could be due to a slow network connection or insufficient device memory.';
                    }
                    
                    // Show fallback message with buttons
                    fallbackMessage.innerHTML = `
                        <h3>${errorTitle}</h3>
                        <p>${errorMessage}</p>
                        <p style="color: #ff6b6b; font-family: monospace; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px; font-size: 12px; overflow-wrap: break-word;">
                            ${errorDetails}
                        </p>
                        <div class="fallback-buttons">
                            <button id="try-again-btn-error" class="fallback-btn">
                                <i class='bx bx-refresh'></i> Try Again
                            </button>
                            <button id="view-model-btn-error" class="fallback-btn">
                                <i class='bx bx-cube'></i> View 3D Model
                            </button>
                        </div>
                    `;
                    fallbackMessage.style.display = 'block';
                    
                    // Add event listeners for the buttons
                    setTimeout(() => {
                        const tryAgainBtnError = document.getElementById('try-again-btn-error');
                        const viewModelBtnError = document.getElementById('view-model-btn-error');
                        
                        if (tryAgainBtnError) {
                            tryAgainBtnError.onclick = () => {
                                window.location.reload();
                            };
                        }
                        
                        if (viewModelBtnError) {
                            viewModelBtnError.onclick = () => {
                                fallbackMessage.style.display = 'none';
                                initializeFallback();
                            };
                        }
                    }, 0);
                }
            }

            // Handle video ready event
            function handleVideoReady(video) {
                videoElement = video;
                
                // Make sure video is visible
                if (videoElement) {
                    videoElement.style.display = 'block';
                }
            }
            
            // Handle hand detected event
            function handleHandDetected(isDetected) {
                if (isDetected) {
                    handDetectedOnce = true;
                    updatePreviewStatus('Hand detected', 'detected');
                } else {
                    updatePreviewStatus('Looking for hand...', 'normal');
                }
            }

            // Initialize fallback 3D viewer
            async function initializeFallback() {
                loadingText.textContent = 'Loading 3D viewer...';
                loadingScreen.style.display = 'flex';
                
                try {
                    // Dispose current tracker if exists
                    if (wristTracker && typeof wristTracker.dispose === 'function') {
                        try {
                            wristTracker.dispose();
                            wristTracker = null;
                        } catch (error) {
                            console.warn('Error disposing wrist tracker:', error);
                        }
                    }
                    
                    // Hide any error messages
                    if (fallbackMessage) {
                        fallbackMessage.style.display = 'none';
                    }
                    
                    if (statusMessage) {
                        statusMessage.style.display = 'none';
                    }
                    
                    if (cameraPreview) {
                        cameraPreview.style.display = 'none';
                    }
                    
                    // Force a page reload to ensure a clean WebGL context
                    // This is the most reliable way to reset the WebGL context
                    const currentUrl = window.location.href;
                    const fallbackUrl = new URL(currentUrl);
                    fallbackUrl.searchParams.set('mode', 'fallback');
                    
                    // Redirect to fallback mode
                    console.log('Redirecting to fallback mode:', fallbackUrl.toString());
                    window.location.href = fallbackUrl.toString();
                    return;
                    
                } catch (error) {
                    console.error('Error initializing 3D viewer:', error);
                    loadingText.textContent = 'Failed to load 3D viewer';
                    
                    // Show error message
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        fallbackMessage.innerHTML = `
                            <h3>3D Viewer Error</h3>
                            <p>There was a problem loading the 3D viewer.</p>
                            <p>Please try refreshing the page.</p>
                            <button onclick="window.location.reload()" class="fallback-btn" style="margin: 10px auto; display: block;">
                                <i class='bx bx-refresh'></i> Refresh Page
                            </button>
                        `;
                        fallbackMessage.style.display = 'block';
                    }, 1000);
                }
            }

            // Handle wrist detection
            function handleWristDetected(position) {
                wristDetectedOnce = true;
                handDetectedOnce = true;
                
                // Update status based on how long it took to detect
                const detectionTime = Date.now() - detectionStartTime;
                
                if (detectionTime < 5000) {
                    updateStatusMessage('Wrist detected! Try on in progress...', false);
                } else {
                    updateStatusMessage('Wrist detected! Adjusting model...', false);
                }
                
                statusMessage.style.opacity = '0.5';
                
                // Update preview status
                updatePreviewStatus('Wrist tracked successfully!', 'detected');
                
                // Show size control
                sizeControl.style.display = 'flex';
            }

            function handleWristLost(reason) {
                if (reason === 'tracking_failed') {
                    console.warn('Wrist tracking failed, showing options');
                    
                    // Show fallback message with buttons
                    fallbackMessage.style.display = 'block';
                    statusMessage.style.display = 'none';
                    
                    // Hide size control
                    sizeControl.style.display = 'none';
                    
                    // Update preview status
                    updatePreviewStatus('Tracking failed', 'error');
                    
                    // Setup button handlers
                    tryAgainBtn.onclick = () => {
                        // Hide fallback message
                        fallbackMessage.style.display = 'none';
                        
                        // Show loading screen
                        loadingScreen.style.display = 'flex';
                        loadingText.textContent = 'Restarting wrist tracking...';
                        
                        // Dispose current tracker if exists
                        if (wristTracker && typeof wristTracker.dispose === 'function') {
                            try {
                                wristTracker.dispose();
                            } catch (error) {
                                console.warn('Error disposing wrist tracker:', error);
                            }
                            wristTracker = null;
                        }
                        
                        // Replace the canvas with a new one to avoid WebGL context issues
                        const oldCanvas = document.getElementById('ar-canvas');
                        const newCanvas = document.createElement('canvas');
                        newCanvas.id = 'ar-canvas';
                        
                        // Set dimensions safely
                        if (oldCanvas) {
                            // Use existing dimensions if available
                            newCanvas.width = oldCanvas.width || window.innerWidth;
                            newCanvas.height = oldCanvas.height || window.innerHeight;
                            
                            // Copy style if available
                            if (oldCanvas.style) {
                                newCanvas.style.cssText = oldCanvas.style.cssText;
                            } else {
                                // Set default styles
                                newCanvas.style.position = 'absolute';
                                newCanvas.style.top = '0';
                                newCanvas.style.left = '0';
                                newCanvas.style.width = '100%';
                                newCanvas.style.height = '100%';
                            }
                            
                            // Replace the old canvas
                            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
                        } else {
                            // If old canvas doesn't exist, create a new one with default dimensions
                            newCanvas.width = window.innerWidth;
                            newCanvas.height = window.innerHeight;
                            newCanvas.style.position = 'absolute';
                            newCanvas.style.top = '0';
                            newCanvas.style.left = '0';
                            newCanvas.style.width = '100%';
                            newCanvas.style.height = '100%';
                            
                            // Append to container
                            container.appendChild(newCanvas);
                        }
                        
                        // Reset detection flags
                        handDetectedOnce = false;
                        wristDetectedOnce = false;
                        
                        // Reinitialize after a short delay
                        setTimeout(() => {
                            initialize();
                        }, 1000);
                    };
                    
                    viewModelBtn.onclick = () => {
                        // Hide fallback message
                        fallbackMessage.style.display = 'none';
                        cameraPreview.style.display = 'none';
                        
                        // Initialize 3D viewer
                        initializeFallback();
                    };
                    
                    return;
                }
                
                // Normal temporary loss of tracking
                if (handDetectedOnce) {
                    updateStatusMessage('Wrist lost. Please keep your hand in view...', false);
                    updatePreviewStatus('Wrist lost, keep hand in view', 'normal');
                } else {
                    updateStatusMessage('Looking for your wrist...', false);
                    updatePreviewStatus('Looking for hand...', 'normal');
                }
                
                // Hide size control on temporary loss too
                sizeControl.style.display = 'none';
                
                statusMessage.style.opacity = '1';
            }

            // Handle exit button
            exitBtn.addEventListener('click', () => {
                window.location.href = `/product/${watchData.slug}/`;
            });

            // Handle capture button
            captureBtn.addEventListener('click', () => {
                // Create a temporary canvas to combine video and 3D model
                const tempCanvas = document.createElement('canvas');
                const width = window.innerWidth;
                const height = window.innerHeight;
                tempCanvas.width = width;
                tempCanvas.height = height;
                const ctx = tempCanvas.getContext('2d');
                
                // Draw video first (if available)
                if (videoElement) {
                    ctx.drawImage(videoElement, 0, 0, width, height);
                }
                
                // Draw the WebGL canvas on top
                ctx.drawImage(canvas, 0, 0, width, height);
                
                // Get the combined image
                const image = tempCanvas.toDataURL('image/png');
                
                // Create temporary link and trigger download
                const link = document.createElement('a');
                link.href = image;
                link.download = `watch-tryon-${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show confirmation
                const originalText = statusMessage.textContent;
                updateStatusMessage('Screenshot captured!', false);
                
                // Restore original message after 2 seconds
                setTimeout(() => {
                    updateStatusMessage(originalText, false);
                }, 2000);
            });

            // Initialize size control
            function initializeSizeControl() {
                // Update model size when slider changes
                sizeSlider.addEventListener('input', () => {
                    const newSize = parseFloat(sizeSlider.value);
                    updateModelSize(newSize);
                });
                
                // Size buttons
                sizeSmaller.addEventListener('click', () => {
                    const currentSize = parseFloat(sizeSlider.value);
                    const newSize = Math.max(1, currentSize - 0.5);
                    sizeSlider.value = newSize;
                    updateModelSize(newSize);
                });
                
                sizeLarger.addEventListener('click', () => {
                    const currentSize = parseFloat(sizeSlider.value);
                    const newSize = Math.min(5, currentSize + 0.5);
                    sizeSlider.value = newSize;
                    updateModelSize(newSize);
                });
            }
            
            // Update model size
            function updateModelSize(size) {
                if (wristTracker && wristTracker.watchModel) {
                    wristTracker.watchModel.scale.set(size, size, size);
                }
            }

            // Start initialization
            initialize();
            
            // Initialize size control
            initializeSizeControl();
        }

        // Initialize fallback 3D viewer directly (without trying AR first)
        async function initializeFallbackDirectly() {
            // Get references to UI elements
            const container = document.querySelector('.container');
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            const statusMessage = document.getElementById('status-message');
            const fallbackMessage = document.getElementById('fallback-message');
            const rotateBtn = document.getElementById('rotate-btn');
            const sizeControl = document.getElementById('size-control');
            const handGuide = document.getElementById('hand-guide');
            const cameraPreview = document.getElementById('camera-preview');
            
            loadingText.textContent = 'Loading 3D viewer...';
            loadingScreen.style.display = 'flex';
            
            try {
                // Save references to UI elements we want to keep
                const uiElements = [];
                
                // Store UI elements we want to preserve
                if (loadingScreen) uiElements.push(loadingScreen);
                if (statusMessage) uiElements.push(statusMessage);
                if (fallbackMessage) uiElements.push(fallbackMessage);
                
                const controls = document.querySelector('.controls');
                if (controls) uiElements.push(controls);
                
                if (sizeControl) uiElements.push(sizeControl);
                if (handGuide) uiElements.push(handGuide);
                if (cameraPreview) uiElements.push(cameraPreview);
                
                // Temporarily remove UI elements from container
                uiElements.forEach(el => {
                    if (el.parentNode === container) {
                        container.removeChild(el);
                    }
                });
                
                // Clear remaining container contents
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                
                // Create a new canvas element
                const canvas = document.createElement('canvas');
                canvas.id = 'ar-canvas';
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.zIndex = '1';
                
                // Add the new canvas
                container.appendChild(canvas);
                
                // Re-add UI elements
                uiElements.forEach(el => {
                    container.appendChild(el);
                });
                
                // Watch data from Django
                const watchData = {
                    modelUrl: '{{ model_url|escapejs }}',
                    slug: '{{ watch.slug|escapejs }}',
                    name: '{{ watch.model_name|escapejs }}'
                };
                
                // Initialize the model viewer
                const modelViewer = await window.initModelViewer({
                    container: container,
                    modelUrl: watchData.modelUrl
                });
                
                if (!modelViewer) {
                    throw new Error('Failed to initialize model viewer');
                }
                
                // Hide loading screen
                loadingScreen.style.display = 'none';
                
                // Show rotate button
                rotateBtn.style.display = 'block';
                
                // Update controls
                rotateBtn.addEventListener('click', () => {
                    if (modelViewer.model) {
                        modelViewer.model.rotation.y += Math.PI / 2;
                    }
                });
                
                // Add instructions overlay
                const instructions = document.createElement('div');
                instructions.style.position = 'absolute';
                instructions.style.bottom = '80px';
                instructions.style.left = '50%';
                instructions.style.transform = 'translateX(-50%)';
                instructions.style.background = 'rgba(0, 0, 0, 0.7)';
                instructions.style.color = 'white';
                instructions.style.padding = '10px 20px';
                instructions.style.borderRadius = '20px';
                instructions.style.fontSize = '14px';
                instructions.style.textAlign = 'center';
                instructions.style.zIndex = '100';
                instructions.style.pointerEvents = 'none';
                instructions.innerHTML = 'Drag to rotate | Pinch or scroll to zoom';
                
                // Add to container
                container.appendChild(instructions);
                
                // Hide after 5 seconds
                setTimeout(() => {
                    instructions.style.opacity = '0';
                    instructions.style.transition = 'opacity 1s ease';
                    
                    // Remove after fade out
                    setTimeout(() => {
                        if (instructions.parentNode) {
                            instructions.parentNode.removeChild(instructions);
                        }
                    }, 1000);
                }, 5000);
                
            } catch (error) {
                console.error('Error initializing 3D viewer:', error);
                loadingText.textContent = 'Failed to load 3D viewer';
                
                // Show error message
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    fallbackMessage.innerHTML = `
                        <h3>3D Viewer Error</h3>
                        <p>There was a problem loading the 3D viewer.</p>
                        <p>Please try refreshing the page.</p>
                        <button onclick="window.location.reload()" class="fallback-btn" style="margin: 10px auto; display: block;">
                            <i class='bx bx-refresh'></i> Refresh Page
                        </button>
                    `;
                    fallbackMessage.style.display = 'block';
                }, 1000);
            }
        }

        // Start loading scripts when the page is ready
        document.addEventListener('DOMContentLoaded', loadCustomScripts);
    </script>
</body>
</html>

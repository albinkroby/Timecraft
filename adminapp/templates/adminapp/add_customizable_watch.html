{% extends "adminapp/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% block admin_content %}
<div class="container mt-5">
    <h2 class="mb-4">Add Customizable Watch - Step 1: Watch Details</h2>
    <form method="post" enctype="multipart/form-data" id="customizableWatchForm">
        {% csrf_token %}
        <div class="card border-0">
            <div class="card-body">
                {% for field in form %}
                    <div class="form-group mb-3">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {% if field.name == 'model_file' or field.name == 'thumbnail' %}
                            <div class="custom-file">
                                {{ field|add_class:"custom-file-input" }}
                            </div>
                            <div class="mt-2">
                                <img id="{{ field.name }}_preview" src="#" alt="Preview" style="max-width: 200px; max-height: 200px; display: none;">
                            </div>
                            <div class="invalid-feedback">
                                {{ field.errors }}
                            </div>
                        {% else %}
                            {{ field|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                        
                    </div>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Next: Add Parts</button>
    </form>
</div>

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>
<script>
$(document).ready(function() {
    // Custom file input
    $('.custom-file-input').on('change', function(e) {
        e.preventDefault();  // Prevent form submission
        let fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').addClass("selected").html(fileName);
        
        // Preview image
        if (this.files && this.files[0]) {
            let reader = new FileReader();
            let preview = $(`#${this.name}_preview`);
            
            reader.onload = function(e) {
                preview.attr('src', e.target.result);
                preview.show();
            }
            
            reader.readAsDataURL(this.files[0]);
        }
    });

    // Add custom method for unique name validation
    $.validator.addMethod("uniqueName", function(value, element) {
        var isUnique = false;
        $.ajax({
            url: "{% url 'adminapp:check_watch_name' %}",  // You'll need to create this URL
            type: "GET",
            async: false,
            data: { name: value },
            success: function(response) {
                isUnique = response.is_unique;
            }
        });
        return isUnique;
    }, "This watch name already exists. Please choose a different name.");

    // Form validation
    $("#customizableWatchForm").validate({
        rules: {
            name: {
                required: true,
                minlength: 3,
                uniqueName: true
            },
            description: {
                required: true,
                minlength: 10
            },
            base_price: {
                required: true,
                number: true,
                min: 0
            },
            model_file: {
                required: true,
                extension: "gltf|glb"
            },
            thumbnail: {
                required: true,
                extension: "png|jpg|jpeg"
            }
        },
        messages: {
            name: {
                required: "Please enter a name for the watch",
                minlength: "Name must be at least 3 characters long",
                uniqueName: "This watch name already exists. Please choose a different name."
            },
            description: {
                required: "Please enter a description",
                minlength: "Description must be at least 10 characters long"
            },
            base_price: {
                required: "Please enter a base price",
                number: "Please enter a valid number",
                min: "Base price must be 0 or greater"
            },
            model_file: {
                required: "Please upload a 3D model file",
                extension: "Please upload a valid GLTF or GLB file"
            },
            thumbnail: {
                required: "Please upload a thumbnail image",
                extension: "Please upload a valid PNG, JPG, or JPEG file"
            }
        },
        errorElement: 'div',
        errorPlacement: function(error, element) {
            error.addClass('invalid-feedback');
            element.closest('.form-group').append(error);
        },
        highlight: function(element, errorClass, validClass) {
            $(element).addClass('is-invalid').removeClass('is-valid');
        },
        unhighlight: function(element, errorClass, validClass) {
            $(element).removeClass('is-invalid').addClass('is-valid');
        }
    });

    // Custom submit handler
    $("#customizableWatchForm").on('submit', function(e) {
        e.preventDefault();  // Prevent default form submission
        if ($("#customizableWatchForm").valid()) {
            this.submit();  // If form is valid, submit it
        }
    });
});
</script>
{% endblock %}
{% endblock %}